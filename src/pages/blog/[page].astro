---
import type { GetStaticPaths, Page } from 'astro';
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import { POSTS_PER_PAGE } from '../../consts';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);
  const sortedPosts = allPosts.sort((a, b) =>
    new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );

  // Generate pages starting from page 2 (page 1 is handled by index.astro)
  const paths = [];
  const totalPages = Math.ceil(sortedPosts.length / POSTS_PER_PAGE);

  for (let i = 2; i <= totalPages; i++) {
    const start = (i - 1) * POSTS_PER_PAGE;
    const end = start + POSTS_PER_PAGE;
    paths.push({
      params: { page: String(i) },
      props: {
        posts: sortedPosts.slice(start, end),
        currentPage: i,
        totalPages,
      },
    });
  }

  return paths;
};

interface Props {
  posts: any[];
  currentPage: number;
  totalPages: number;
}

const { posts, currentPage, totalPages } = Astro.props;
const hasPrevPage = currentPage > 1;
const hasNextPage = currentPage < totalPages;
const prevPageUrl = currentPage === 2 ? '/' : `/blog/${currentPage - 1}/`;
const nextPageUrl = `/blog/${currentPage + 1}/`;
---

<BaseLayout
  title="Keng Susumpow"
  description="Random Access Memory."
  featuredImage="/images/generic/main-cover.jpg"
>
  <section class="blog single">
    <div class="wrap">
      {posts.map((post) => (
        <BlogPostCard post={post} />
      ))}
    </div>
  </section>

  <section class="pagination">
    {hasPrevPage && (
      <div class="pagination__prev">
        <a href={prevPageUrl} class="button button--large">
          <svg class="icon" aria-hidden="true"><use href="#icon-angle-left"></use></svg>
          <span>Newer Posts</span>
        </a>
      </div>
    )}
    {hasNextPage && (
      <div class="pagination__next">
        <a href={nextPageUrl} class="button button--large">
          <span>Older Posts</span>
          <svg class="icon" aria-hidden="true"><use href="#icon-angle-right"></use></svg>
        </a>
      </div>
    )}
  </section>
</BaseLayout>
